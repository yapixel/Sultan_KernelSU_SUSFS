name: Build and Release Sultan Kernels

permissions:
  contents: write  # Allow writing to repository contents (for pushing tags)
  actions: write   # Allows triggering actions

on:
  workflow_dispatch:
    inputs:
      make_release:
        description: 'Do you want to create a release?'
        required: true
        type: boolean
        default: true

jobs:
  generate-tag:
    runs-on: ubuntu-latest
    if: ${{ inputs.make_release }}
    outputs:
      new_tag: ${{ steps.generate-tag.outputs.new_tag }}
    env:
      REPO_OWNER: yapixel
      REPO_NAME: Sultan_KernelSU_SUSFS
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate and Create New Tag
        id: generate-tag
        run: |
          # Fetch the latest tag from this repository
          LATEST_TAG=$(gh api repos/$REPO_OWNER/$REPO_NAME/tags --jq '.[0].name')
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v1.5.12-r0"  # Default to v1.5.12-r0 if no tag exists
          fi
          
          # Increment the suffix (e.g., v1.5.12-r0 becomes v1.5.12-r1)
          NEW_TAG=$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')
          
          # Output the new tag to be used
          echo "New tag: $NEW_TAG"
          
          # Set the new tag as output
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          
          # Create the tag in the repository
          git tag $NEW_TAG
          git push origin $NEW_TAG

  build-kernel:
    runs-on: ubuntu-latest
    needs: generate-tag
    if: ${{ inputs.make_release }}
    strategy:
      matrix:
        variant:
          - name: RKSU
            ksu_setup_url: "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh"
            ksu_branch: "susfs-main"
            susfs_repo: "https://gitlab.com/pershoot/susfs4ksu.git"
            susfs_commit: ""
            apply_manual_hooks: true
            additional_patches: []
            zip_prefix: "RKSU"
          - name: MKSU
            ksu_setup_url: "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh"
            ksu_branch: "main"
            susfs_repo: "https://gitlab.com/pershoot/susfs4ksu.git"
            susfs_commit: ""
            apply_manual_hooks: true
            additional_patches:
              - path: "../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
                apply_dir: "./KernelSU"
                fuzz: 0
              - path: "../../kernel_patches/mksu/fix_core_hook.c.patch"
                apply_dir: "./KernelSU"
                fuzz: 3
            zip_prefix: "MKSU"
          - name: KSUN
            ksu_setup_url: "https://raw.githubusercontent.com/pershoot/KernelSU-Next/next-susfs/kernel/setup.sh"
            ksu_branch: "next-susfs"
            susfs_repo: "https://gitlab.com/pershoot/susfs4ksu.git"
            susfs_commit: ""
            apply_manual_hooks: true
            additional_patches: []
            zip_prefix: "KSUN"
          - name: KSU
            ksu_setup_url: "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh"
            ksu_branch: "37ef0d27067d3d7e7bf07a80547a1949864789c4"
            susfs_repo: "https://gitlab.com/simonpunk/susfs4ksu.git"
            susfs_commit: "b8d364c77554e10c6e1192242f53e5c0903f8728"
            apply_manual_hooks: false
            additional_patches:
              - path: "../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
                apply_dir: "./KernelSU"
                fuzz: 0
              - path: "../kernel_patches/syscall_hook/min_scope_syscall_hooks_v1.5.patch"
                apply_dir: "."
                fuzz: 3
            zip_prefix: "KSU"
    steps:
      - name: Installing dependencies
        run: |
          sudo apt update
          sudo apt install -y gcc-aarch64-linux-gnu

      - name: Set CONFIG Environment Variable
        run: |
          CONFIG="android_kernel_google_zuma"
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV
          echo "CONFIG set to: $CONFIG"

      - name: Get Latest Sultan Tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST_SULTAN_TAG=$(gh api repos/kerneltoast/android_kernel_google_zuma/tags --jq '.[0].name')
          if [ -z "$LATEST_SULTAN_TAG" ]; then
            echo "Error: Could not fetch latest Sultan tag"
            exit 1
          fi
          echo "LATEST_SULTAN_TAG=$LATEST_SULTAN_TAG" >> $GITHUB_ENV
          echo "Latest Sultan tag: $LATEST_SULTAN_TAG"

      - name: Clone AnyKernel3 and Other Dependencies
        run: |
          echo "Cloning AnyKernel3 and other dependencies..."
          ANYKERNEL_BRANCH="sultan-zuma"
          SUSFS_BRANCH="gki-android14-6.1-dev"
          echo "Using branch for AnyKernel3: $ANYKERNEL_BRANCH"
          echo "Using branch for SUSFS: $SUSFS_BRANCH"
          git clone https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH"
          git clone ${{ matrix.variant.susfs_repo }} -b "$SUSFS_BRANCH"
          if [ -n "${{ matrix.variant.susfs_commit }}" ]; then
            cd susfs4ksu
            git checkout ${{ matrix.variant.susfs_commit }}
            cd ..
          fi
          git clone https://github.com/yapixel/kernel_patches.git
          git clone https://github.com/kerneltoast/${{ env.CONFIG }}

      - name: Add KernelSU
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"
          echo "Adding KernelSU..."
          curl -LSs "${{ matrix.variant.ksu_setup_url }}" | bash -s ${{ matrix.variant.ksu_branch }}

      - name: Apply SUSFS Patches
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"
          echo "Applying SUSFS patches..."
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch ./
          cp ../susfs4ksu/kernel_patches/fs/* ./fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./include/linux/
          patch -p1 -F 3 < 50_add_susfs_in_gki-android14-6.1.patch || true
          if [ "${{ matrix.variant.apply_manual_hooks }}" = "true" ]; then
            cp ../susfs4ksu/kernel_patches/60_scope-minimized_manual_hooks.patch ./
            patch -p1 < 60_scope-minimized_manual_hooks.patch
          fi
          cp ../kernel_patches/sultan/sys.c_fix.patch ./
          patch -p1 --fuzz=3 < sys.c_fix.patch
          for patch in ${{ matrix.variant.additional_patches }}; do
            IFS=':' read -r path apply_dir fuzz <<< "$patch"
            if [ -n "$path" ]; then
              cp "$path" "$apply_dir/"
              cd "$apply_dir"
              patch -p1 --fuzz="$fuzz" < "$(basename "$path")" || [ "$fuzz" = "0" ]
              cd - > /dev/null
            fi
          done

      - name: Getting KernelSU Version
        run: |
          cd "$CONFIG/KernelSU${{ matrix.variant.name == 'KSUN' && '-Next' || '' }}/kernel"
          BASE_VERSION=10200
          COMMIT_COUNT=$(/usr/bin/git rev-list --count HEAD)
          KSU_VERSION=$(expr $COMMIT_COUNT "+" $BASE_VERSION)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV

      - name: Apply Hide Stuff Patches
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"
          cp ../kernel_patches/69_hide_stuff.patch ./
          patch -p1 -F 3 < 69_hide_stuff.patch

      - name: Add SUSFS Configuration Settings
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"
          echo "Adding configuration settings to zuma_defconfig..."
          echo "CONFIG_KSU=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_KPROBES_HOOK=n" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_TMPFS_XATTR=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_TCP_CONG_BBR=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_NET_SCH_FQ=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_TCP_CONG_BIC=n" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_TCP_CONG_WESTWOOD=n" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_TCP_CONG_HTCP=n" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_BPF_STREAM_PARSER=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_NETFILTER_XT_SET=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_MAX=65534" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_BITMAP_IP=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_BITMAP_PORT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_IP=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_IPMARK=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_IPPORT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_IPMAC=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_MAC=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_NET=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_NETNET=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_NETPORT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP_SET_LIST_SET=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP6_NF_NAT=y" >> ./arch/arm64/configs/zuma_defconfig
          echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> ./arch/arm64/configs/zuma_defconfig

      - name: Run sed and perl Commands
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"
          echo "Running sed commands..."
          sed -i 's/CONFIG_LOCALVERSION="-Sultan"/CONFIG_LOCALVERSION="-g4e52994af56a-ab13829026"/' ./arch/arm64/configs/zuma_defconfig
          echo "Kernel version suffix set to -g4e52994af56a-ab13829026"

      - name: Build the Kernel
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"
          echo "Building the kernel..."
          if [ "zuma" == "zumapro" ]; then
            export KCFLAGS="-march=armv8.6-a -O3 --param=min-pagesize=0"
          fi
          make zuma_defconfig -j$(nproc --all)
          make V=1 -j$(nproc --all)

      - name: Copy Images
        run: |
          echo "Changing to configuration directory: $CONFIG..."
          cd "$CONFIG"
          echo "Copying Image.lz4 and concatenating DTB files..."
          cp ./out/arch/arm64/boot/Image.lz4 ../AnyKernel3/Image.lz4
          if [ "zuma" == "gs201" ]; then
            cat ./out/google-devices/gs201/dts/*.dtb > ../AnyKernel3/dtb
          elif [ "zuma" == "zuma" ]; then
            cat ./out/google-devices/zuma/dts/*.dtb > ../AnyKernel3/dtb
          elif [ "zuma" == "zumapro" ]; then
            cat ./out/google-devices/zumapro/dts/*.dtb > ../AnyKernel3/dtb
          fi

      - name: Create ZIP Files for Different Formats
        run: |
          echo "Navigating to AnyKernel3 directory..."
          cd ./AnyKernel3
          ZIP_NAME="${{ matrix.variant.zip_prefix }}-${{ env.KSUVER }}-zuma_A16_Sultan-${{ env.LATEST_SULTAN_TAG }}_SUSFS-${{ needs.generate-tag.outputs.new_tag }}.zip"
          echo "Creating zip file $ZIP_NAME..."
          zip -r "../$ZIP_NAME" ./*

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-zuma-${{ matrix.variant.name }}
          path: |
            *.zip

  trigger-release:
    runs-on: ubuntu-latest
    needs:
      - generate-tag
      - build-kernel
    if: ${{ inputs.make_release }}
    env:
      GH_TOKEN: ${{ github.token }}
      RELEASE_NAME: "*TEST BUILD* Sultan Kernels With KernelSU/MKSU & SUSFS v1.5.12 *TEST BUILD*"
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Build Date
        id: set-build-date
        run: |
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Define Release Notes
        id: define-release-notes
        run: |
          RELEASE_NOTES=$(cat << 'EOF'
          This release contains KernelSU and MKSU variants with SUSFS v1.5.12
          
          âš ï¸ **COMPATIBILITY NOTICE** âš ï¸
          Please ensure compatibility by comparing release dates with official Sultan kernel releases:
          - Check official Sultan releases: https://github.com/kerneltoast/android_kernel_google_gs201/releases
          - This build is based on the latest Sultan kernel commits as of build date
          - Always verify your device's Android version matches the kernel target (Android 14)
          - Recommended to use kernels released within 30 days of official Sultan updates
          
          Module: 
          -> https://github.com/sidex15/ksu_module_susfs
          
          Managers:
          -> https://github.com/backslashxx/KernelSU
          
          Features:
          [+] KernelSU Magic Managers v1.0.5
          [+] SUSFS v1.5.12
          [+] Maphide LineageOS Detections
          [+] Futile Maphide for jit-zygote-cache Detections
          [+] Magic Mount Support
          
          ðŸ“… **Release Date Compatibility Check:**
          - Built on: ${{ steps.set-build-date.outputs.build_date }}
          EOF
          )
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts

      - name: Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ needs.generate-tag.outputs.new_tag }}
          prerelease: true
          release_name: ${{ env.RELEASE_NAME }}
          body: ${{ steps.define-release-notes.outputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload Release Assets Dynamically
        run: |
          for file in ./downloaded-artifacts/kernel-*/*; do
              if [ -d "$file" ]; then
                  continue
              fi
              echo "Uploading $file..."
              gh release upload ${{ needs.generate-tag.outputs.new_tag }} "$file"
          done
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Display Files Uploaded
        run: |
          echo "GitHub release created with the following files:"
          ls ./downloaded-artifacts/**/*
